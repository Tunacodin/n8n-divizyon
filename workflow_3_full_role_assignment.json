{
  "name": "ðŸŽ­ Circle - Role Assignment Engine (FULL)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "assign-role",
        "responseMode": "responseNode"
      },
      "name": "Rol Atama Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {"name": "email", "value": "={{ $json.body?.email }}"},
            {"name": "dijital_urun", "value": "={{ $json.body?.dijital_urun_score }}"},
            {"name": "kreatif_yapim", "value": "={{ $json.body?.kreatif_yapim_score }}"},
            {"name": "dijital_deneyim", "value": "={{ $json.body?.dijital_deneyim_score }}"}
          ]
        }
      },
      "name": "SkorlarÄ± HazÄ±rla",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [460, 400]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {"__rl": true, "value": "GOOGLE_SHEET_ID_PLACEHOLDER", "mode": "id"},
        "sheetName": {"__rl": true, "value": "Nihai AÄž Ãœyesi", "mode": "name"},
        "filters": {},
        "options": {}
      },
      "name": "Nihai Liste Oku",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "const dijitalUrun = parseFloat($input.first().json.dijital_urun) || 0;\nconst kreatifYapim = parseFloat($input.first().json.kreatif_yapim) || 0;\nconst dijitalDeneyim = parseFloat($input.first().json.dijital_deneyim) || 0;\n\nconst scores = {\n  'Dijital ÃœrÃ¼n': dijitalUrun,\n  'Kreatif YapÄ±m': kreatifYapim,\n  'Dijital Deneyim': dijitalDeneyim\n};\n\nconst maxScore = Math.max(dijitalUrun, kreatifYapim, dijitalDeneyim);\nconst topRoles = Object.keys(scores).filter(k => scores[k] === maxScore);\n\n// Rol sayÄ±mÄ±\nconst nList = $input.last().json;\nconst roleCounts = {\n  'Dijital ÃœrÃ¼n': nList.filter(u => u['Ana Rol'] === 'Dijital ÃœrÃ¼n').length,\n  'Kreatif YapÄ±m': nList.filter(u => u['Ana Rol'] === 'Kreatif YapÄ±m').length,\n  'Dijital Deneyim': nList.filter(u => u['Ana Rol'] === 'Dijital Deneyim').length\n};\n\nlet assignedRole;\nif (topRoles.length > 1) {\n  assignedRole = topRoles.reduce((min, role) => \n    roleCounts[role] < roleCounts[min] ? role : min\n  );\n} else {\n  assignedRole = topRoles[0];\n}\n\nreturn {\n  email: $input.first().json.email,\n  ana_rol: assignedRole,\n  max_score: maxScore,\n  all_scores: scores,\n  role_counts: roleCounts,\n  has_multiple: topRoles.length > 1\n};"
      },
      "name": "Rol Hesapla (AkÄ±llÄ±)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": {"__rl": true, "value": "GOOGLE_SHEET_ID_PLACEHOLDER", "mode": "id"},
        "sheetName": {"__rl": true, "value": "BaÅŸvuru Sheet", "mode": "name"},
        "filters": {
          "conditions": [
            {"column": "Email", "value": "={{ $json.email }}"}
          ]
        }
      },
      "name": "KullanÄ±cÄ± Bilgisi Al",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1120, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.circle.so/v1/community_members",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "Authorization", "value": "Token CIRCLE_API_TOKEN_PLACEHOLDER"}
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "email", "value": "={{ $json.email }}"},
            {"name": "name", "value": "={{ $('KullanÄ±cÄ± Bilgisi Al').item.json['Ad Soyad'] }}"},
            {"name": "tags", "value": "={{ $json.ana_rol }}"}
          ]
        },
        "options": {}
      },
      "name": "Circle API - Tag Ata",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {"__rl": true, "value": "GOOGLE_SHEET_ID_PLACEHOLDER", "mode": "id"},
        "sheetName": {"__rl": true, "value": "Nihai AÄž Ãœyesi", "mode": "name"},
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Email": "={{ $('KullanÄ±cÄ± Bilgisi Al').item.json.Email }}",
            "Ad Soyad": "={{ $('KullanÄ±cÄ± Bilgisi Al').item.json['Ad Soyad'] }}",
            "Circle User ID": "={{ $json.id }}",
            "Ana Rol": "={{ $('Rol Hesapla (AkÄ±llÄ±)').item.json.ana_rol }}",
            "Tags": "={{ $('Rol Hesapla (AkÄ±llÄ±)').item.json.ana_rol }}",
            "KatÄ±lÄ±m Tarihi": "={{ $now.toISO() }}",
            "Warning Count": "0",
            "Status": "Active"
          }
        }
      },
      "name": "Nihai Listeye Ekle",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "fromEmail": "noreply@circleapp.com",
        "toEmail": "={{ $('KullanÄ±cÄ± Bilgisi Al').item.json.Email }}",
        "subject": "ðŸŽ‰ RolÃ¼nÃ¼z AtandÄ± - Circle",
        "emailType": "html",
        "message": "=<h2>Tebrikler!</h2><p>Circle topluluÄŸundaki rolÃ¼nÃ¼z belirlendi:</p><p><strong>Ana Rol:</strong> {{ $('Rol Hesapla (AkÄ±llÄ±)').item.json.ana_rol }}</p><p><strong>Skorunuz:</strong> {{ $('Rol Hesapla (AkÄ±llÄ±)').item.json.max_score }}</p><p>ArtÄ±k topluluk aktivitelerine katÄ±labilirsiniz!</p>",
        "options": {}
      },
      "name": "Rol AtandÄ± Maili",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [1780, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"status\": \"success\", \"email\": $('KullanÄ±cÄ± Bilgisi Al').item.json.Email, \"rol\": $('Rol Hesapla (AkÄ±llÄ±)').item.json.ana_rol, \"circle_id\": $json.id } }}"
      },
      "name": "Success Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2000, 400]
    }
  ],
  "connections": {
    "Rol Atama Trigger": {"main": [[{"node": "SkorlarÄ± HazÄ±rla", "type": "main", "index": 0}]]},
    "SkorlarÄ± HazÄ±rla": {"main": [[{"node": "Nihai Liste Oku", "type": "main", "index": 0}]]},
    "Nihai Liste Oku": {"main": [[{"node": "Rol Hesapla (AkÄ±llÄ±)", "type": "main", "index": 0}]]},
    "Rol Hesapla (AkÄ±llÄ±)": {"main": [[{"node": "KullanÄ±cÄ± Bilgisi Al", "type": "main", "index": 0}]]},
    "KullanÄ±cÄ± Bilgisi Al": {"main": [[{"node": "Circle API - Tag Ata", "type": "main", "index": 0}]]},
    "Circle API - Tag Ata": {"main": [[{"node": "Nihai Listeye Ekle", "type": "main", "index": 0}]]},
    "Nihai Listeye Ekle": {"main": [[{"node": "Rol AtandÄ± Maili", "type": "main", "index": 0}]]},
    "Rol AtandÄ± Maili": {"main": [[{"node": "Success Response", "type": "main", "index": 0}]]}
  },
  "settings": {"executionOrder": "v1"}
}
